<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>SonAR Overview</title>
  <meta name="description" content="SoNAR Overview">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300;0,400;0,600;0,700;1,300;1,400;1,600;1,700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">

  <script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script>
  <script src="https://rawcdn.githack.com/Kcnarf/d3-weighted-voronoi/v1.0.0/build/d3-weighted-voronoi.js"></script>
  <script src="https://raw.githack.com/Kcnarf/d3-voronoi-map/master/build/d3-voronoi-map.js"></script>
  <style>
    body {
      background-color: rgb(250, 250, 250);
      font-family: 'Open Sans', sans-serif;
      margin:0;
      overflow-y: hidden;
      overflow-x: hidden;
    }



    .cell {
      stroke: white;
      stroke-width: 1px;
    }

    .labelbg {
      fill: #fafafa;
      text-anchor: middle;
      font-size: 12px;
      font-weight: 600;
      stroke-width: 6px;
      stroke: #fafafa;
      stroke-linecap: round;
      text-transform:uppercase;
    }


    .label {
      fill: #737373;
      text-anchor: middle;
      font-size: 12px;
      font-weight: 600;
      text-transform:uppercase;
    }


    div.tooltip {
      position: absolute;
      text-align: left;
      width: auto;
      height: auto;
      margin: 2;
      padding: 2px;
      font-size: 11px;
      background: white;
      color: black;
      border: solid #bdbdbd;
      border-width: 1px;
      border-radius: 8px;
      pointer-events: none;
    }

    div.tooltip p {
      margin: 5px;
      padding: 0;
    }

    #vis {
      position: fixed;
    }

    #visgeo {
      position: fixed;
    }


    #timelineDiv {
      width: 100%;
      height: 25%;
      position: fixed;
      bottom: 0px;
      left:0;
      text-align: right;
    }

    #yearSlider {
      position: absolute;
      bottom: 0px;
      vertical-align: middle;
      width: 100%;
      height: 50px;
      text-align: center;
    }

    input[type="range"] {
      width:100%;
      direction: ltr;
    }
.range-value{
  margin:0;
}

    #svg{
      margin: 0;
    }

.tick line{
  display:none;
}

.timelineRect{
  fill: #fafafa;
  stroke: #d9d9d9;
  stroke-width:3;
  cursor: pointer;
}

.timelineRect.timelineRecthover{
  fill: #d9d9d9;
}

.timelineRect.timelineRectSelected{
  fill: #d9d9d9;
}


.info{
  font-size: 12px;
  padding: 12px;
  width: 250px;
  height: 70%;
  position: fixed;
  top: 0px;
  left:0px;
  color: black;
  background-color: rgba(250, 250, 250, 0.75);
}

h1{
  margin-top: 0;
  font-size: 22px;
}

.info p{
  font-size: 12px;
}

.infohighlight{
}

.gnd-highlight{
  font-weight: bold;
  color: #ea635e;
  text-decoration: underline;
}

.kpe-highlight{
  font-weight: bold;
  color: #494b9a;
  text-decoration: underline;
}

.dnb-highlight{
  font-weight: bold;
  color: #44b78d;
  text-decoration: underline;
}

.sbb-highlight{
  font-weight: bold;
  color: #e8ce4b;
  text-decoration: underline;
}

.zdb-highlight{
  font-weight: bold;
  color: #e5994c;
  text-decoration: underline;
}

.comp-highlight{
  font-weight: bold;
  color: rgb(56, 56, 56);
  text-decoration: underline;
}

/* unvisited link */
a:link {
  color: black;
}

/* visited link */
a:visited {
  color: black;
}

/* mouse over link */
a:hover {
  color: black;
}

/* selected link */
a:active {
  color: black;
}

.searchbar{
  font-size: 12px;
  font-weight: bold;
  margin: 12px;
   width: 100%;
  height: 44px;
  position: absolute;
  top: 0px;
  margin: auto;
  color: black;
  text-align: center;
  vertical-align: middle;
  text-transform: uppercase;
  display: flex;
  justify-content: center;
}

#searchfield {
  padding:0;
  margin:0;
  padding-top: 5px;
  position: relative;
  width: 310px;
  height: 25px;
  text-align: center;
  vertical-align: middle;
  background-color: white;
  border: solid #bdbdbd;
  border-width: 0px;
  border-radius: 8px;
}

.searchbuttons{
  padding:0;
font-size: 18px;
height: 22px;
width: 22px;
text-align: center;
vertical-align: middle;
border: 0;
background-color: white;
}

#suche{
  width: 250px;
  border: 0;
  font-weight: bold;
  text-align: center;
}

.search-border-wrap {
  padding: 1px;
  margin-top: 12px;
  position: relative;
  width: 310px;
  height: 30px;
  text-align: center;
  vertical-align: middle;
  background-color: white;
  border: solid #bdbdbd;
  border-width: 0px;
  border-radius: 8px;
  position: relative;
  background: linear-gradient(to right, #ea635e, #494b9a, #e5994c, #44b78d, #e8ce4b);
}


.toplistDiv{
  position: fixed;
  height: 75%;
  width: 300px;
  background-color: rgba(255, 255, 255, 0.92);
  color: black;
  border: solid #bdbdbd;
  border-width: 1px;
  border-radius: 8px;
  top: 12.5%;
  left: calc((100% - 300px)/2);
  padding: 10px;
}

.toplisttext{
  position: relative;
  width: 100%;
  height: calc(100% - 1.5em);
  overflow: auto;
}

.toplistentries{
  font-size: 12px;
  margin: 0;
}

.toplistCross{
  font-size: 20px;
  position: absolute;
  top:5px;
  right: 10px;
  margin:0;
  cursor: pointer;
}

.toplistsearch{
  background-color: none;
  width: 90%;
  margin-bottom: 5px;
}

  </style>
</head>

<body>
  <svg id="svg">
    <g id="allvisg">
    <g id="relationsvis"></g>
    <g id="vis"></g>
    <g id="visgeo"></g>
    <g id="visres"></g>
    <g id="vismeet"></g>
    <g id="visuni"></g>
    <g id="viscorp"></g>
  </g>
  </svg>

  <div id="timelineDiv"><svg id="timelineSVG">
    <defs>
  <pattern id="diagonalHatch" width="16" height="16" patternTransform="rotate(-45 0 0)" patternUnits="userSpaceOnUse">
  <line x1="2" y1="0" x2="2" y2="16" style="stroke:#494b9a; stroke-width:2" />
  <line x1="6" y1="0" x2="6" y2="16" style="stroke:#44b78d; stroke-width:2" />
  <line x1="10" y1="0" x2="10" y2="16" style="stroke:#e8ce4b; stroke-width:2" />
  <line x1="14" y1="0" x2="14" y2="16" style="stroke:orange; stroke-width:2" />
  </pattern>

    </defs>
  </svg></div>


  <div class="info">
  <h1>SoNAR (IDH)…</h1>
  <p>beziehungsweise Interfaces to Data for Social Historical Network Analysis and Research, ist eine prototypische Erpopung einer Forschungsinfrastruktur zur systematisch forschungsorientierten Aufbereitung von Massendaten zur Nutzung in der historischen Netzwerkanalyse (HNA). Dabei basiert die Technologie zunächst auf der Zusammenführung der heterogenen Daten (~52 Mio. Knoten, ~185 Mio. Kanten) aus <span class="gnd-highlight">GND</span>, <span class="kpe-highlight">Kalliope</span>, <span class="dnb-highlight">DNB</span>, <span class="zdb-highlight">ZDB</span> und <span class="sbb-highlight">SBB</span>, sowie maschinell <span class="comp-highlight">abgeleiteten Relationen</span> aus diesen Beständen.</p>
  <p><span class="infohighlight">Kurzanleitung:</span><br>
  1. Überblick verschaffen<br>
  2. Suche nutzen und Netzwerke generieren<br>
  3. Netzwerke explorieren<br>
  4. Daten herunterladen
</p>
<p><span class="infohighlight">Weitere Infos & API:</span><br>
- <a href="https://github.com/sonar-idh/jupyter-curriculum">API & Jupyter Notebook HNA Curriculum</a><br>
- <a href="https://github.com/sonar-idhm">Projektdokmentation & Sourcecode</a><br>
- <a href="https://">Impressum, Disclaimer & Datenschutz</a><br>
- <a href="https://sonar.fh-potsdam.de">Projektwebsite & Team</a>
</p>
</div>



<div class="searchbar">
  <div class="search-border-wrap">
  <div id="searchfield">

    <input type="text" id="suche" class="cypher-in" name="suche" value="" placeholder="Generiere ein Netzwerk mit SoNAR">
    <button name="post cypher" id="searchbutton" class="searchbuttons" onclick="post_cypherquery('execute');">
 <i class = "material-icons" style="font-size: 18px">search</i></button>
     <button name="post cypher" id="searchoptions" class="searchbuttons" onclick=""> <i style="font-size: 18px" class = "material-icons">settings</i></button>
    <button name="post cypher" class="searchbuttons" onclick="post_cypherquery('addByQuery');" style="display:none;">Hinzufügen</button>
  </div>
</div>
</div>

  <!-- <div id="timelineDiv"><svg id="timelineSVG" width="200"> </svg></div> -->
  <!-- <div id="yearSlider">
    <div class="range-slider">
      <input class="input-range" type="range" step="50" value="1900" min="1300" max="2000">
      <p class="range-value"></p>
    </div>
  </div> -->

  <script>
    // let range = d3.select(".input-range")
    // let value = d3.select(".range-value")
    //
    // value.html(range.attr('value'));




    var div = d3.select("body").append("div")
      .attr("class", "tooltip")
      .style("opacity", 0);

    div.append("p")

    //begin: constants
    const _2PI = 2 * Math.PI;
    //end: constants


    //begin: layout conf.
    let svg1id = "#vis"
    let svg2id = "#visgeo"
    let svg3id = "#visres"
    let svg4id = "#vismeet"
    let svg5id = "#visuni"
    let svg6id = "#viscorp"

    var svgWidth = window.innerWidth,
      svgHeight = window.innerHeight,
      margin = {
        top: 0,
        right: 0,
        bottom: 0,
        left: 0
      },
      height = svgHeight - margin.top - margin.bottom,
      width = svgWidth - margin.left - margin.right,
      halfWidth = width / 2,
      halfHeight = height / 2,
      quarterWidth = width / 4,
      quarterHeight = height / 4,
      titleY = 20,
      PerNameCenter = [halfWidth, halfHeight]
      GeoNameCenter = [3/4*width, halfHeight]
      ResourcesCenter = [quarterWidth, halfHeight]
      MeetNameCenter = [0.35*width, 0.25*height]
      UniTitleCenter = [halfWidth, 0.2*height]
      CorpNameCenter = [0.65*width, 0.25*height]
    //end: layout conf.




    let windowWidth = window.innerWidth - 2 * margin.left
    let windowHeight = window.innerHeight - 2 * margin.top

    let zoom = d3.zoom()
      .scaleExtent([1 / 3, 8])
      .on("zoom", zoomed)

    function zoomed() {

    d3.select("#allvisg").attr("transform", d3.event.transform);
}

    const svg = d3.select("#svg")
    .attr("width", "100%")
    .attr("height", "100%")
    .attr("preserveAspectRatio", "xMidYMid")
    .attr("viewBox", "0 0 " + windowWidth + " " + windowHeight)
    .call(zoom)




      const timelineVis = d3.select("#timelineSVG")
          .attr("width", "100%")
          .attr("height", "100%")




// function voronoiAll(dataset, svgselector){

      //begin: raw data global def
      let totalCount = 0
      let totalCountGeo = 0
      let totalCountRes = 0
      let totalCountMeet = 0
      let totalCountUni = 0
      let totalCountCorp = 0
      //end: raw data global def



      //begin: treemap conf.
      //let baseRadius = 100
      let Radius
      let RadiusGeo
      let RadiusRes
      let RadiusMeet
      let RadiusUni
      let RadiusCorp
      let CirclingPolygon
      let CirclingPolygonGeo
      let CirclingPolygonRes
      let CirclingPolygonMeet
      let CirclingPolygonUni
      let CirclingPolygonCorp
      let Polygons
      let PolygonsGeo
      let PolygonsRes
      let PolygonsMeet
      let PolygonsUni
      let PolygonsCorp
      //end: treemap conf.

      let top100Value = 0
      let top100ValueGeo = 0
      let top100ValueRes = 0
      let top100ValueMeet = 0
      let top100ValueUni = 0
      let top100ValueCorp = 0
      let otherValue = 0
      let otherValueGeo = 0
      let otherValueRes = 0
      let otherValueMeet = 0
      let otherValueUni = 0
      let otherValueCorp = 0
      let totalValue = 0
      let totalValueGeo = 0
      let totalValueRes = 0
      let totalValueMeet = 0
      let totalValueUni = 0
      let totalValueCorp = 0



      //
      // const formatComma = d3.format(",")

      const radiusScale = d3.scaleSqrt()
        .domain([0, 8000000])
        .range([50, 250])

      const colorScale = d3.scaleOrdinal()
      .range(['#f0f0f0','#d9d9d9','#bdbdbd','#969696','#737373','#525252','#252525'])
        //.range(["rgb(241, 250, 250)","rgb(208, 217, 217)","rgb(175, 184, 184)","rgb(156, 166, 166)","rgb(125, 134, 134)", "rgb(75, 82, 82)"])




const colorScaleEdges = d3.scaleOrdinal()
.domain(["GND", "KPE", "DNB", "SBB", "ZDB", "Comp"])
.range(["#ea635e", "#494b9a", "#44b78d", "#e8ce4b", "#e5994c", "rgb(56, 56, 56)"])

const edgesSizeScale = d3.scaleLinear()
.domain([0, 1, 8000000])
.range([0, 4, 50])

let yearSelected = 1850
let selectionData
let selectionDataState

let selectionDataGeo
let selectionDataStateGeo

let selectionDataRes
let selectionDataStateRes

let selectionDataMeet
let selectionDataStateMeet

let selectionDataUni
let selectionDataStateUni

let selectionDataCorp
let selectionDataStateCorp

      // //begin: reusable d3Selection
      // var drawingArea;
      // var categoryContainer;

      //end: reusable d3Selection

      Promise.all([
  				d3.csv("data/persontopicterms_50er_long-komp.csv"), //data
  				d3.csv("data/persongeonames_50er_long_komp.csv"), //geodata
          d3.csv("data/resourcetopic_50er_long_komp.csv"), //ressources
          d3.csv("data/meetnametopic_50er_long_komp.csv"), //meetname
          d3.csv("data/unititletopic_50er_long_komp.csv"), //unititle
          d3.csv("data/corpname_50er_long_komp.csv"), //corpname
          d3.csv("data/all-relations160821_final.csv"),
          d3.csv("data/all-timeline-relations.csv"),
           //timeline
  			])
  			.then(([data, geodata, resdata, meetdata, unidata, corpdata, relationdata, timelinerelations]) => {

      // d3.csv("persongeonames_50er_long.csv").then(function(data) {





        data.forEach(function(d) {
          d.entityName = d.entityName;
          d.value = +d.value;
          d.year = +d.year;

          totalCount += d.value;
          return d;
        });

        geodata.forEach(function(d) {
          d.entityName = d.entityName;
          d.value = +d.value;
          d.year = +d.year;

          totalCountGeo += d.value;
          return d;
        });

        resdata.forEach(function(d) {
          d.entityName = d.entityName;
          d.value = +d.value;
          d.year = +d.year;

          totalCountRes += d.value;
          return d;
        });

        meetdata.forEach(function(d) {
          d.entityName = d.entityName;
          d.value = +d.value;
          d.year = +d.year;

          totalCountRes += d.value;
          return d;
        });

        unidata.forEach(function(d) {
          d.entityName = d.entityName;
          d.value = +d.value;
          d.year = +d.year;

          totalCountUni += d.value;
          return d;
        });

        corpdata.forEach(function(d) {
          d.entityName = d.entityName;
          d.value = +d.value;
          d.year = +d.year;

          totalCountCorp += d.value;
          return d;
        });

        timelinerelations.forEach(function(d) {
          d.PerPer_GND = +d.PerPer_GND;
          d.CorpPer_GND = +d.CorpPer_GND;
          d.GeoPer_GND = +d.GeoPer_GND;
          d.MeetPer_GND = +d.MeetPer_GND;
          d.UniPer_GND = +d.UniPer_GND;

          d.ResPer_KPE = +d.ResPer_KPE;
          d.ResPer_DNB = +d.ResPer_DNB;
          d.ResPer_SBB = +d.ResPer_SBB;
          d.ResPer_ZDB = +d.ResPer_ZDB;

          d.PerPer_Comp = +d.PerPer_Comp;
          d.CorpPer_Comp = +d.CorpPer_Comp;
        })



        // range.on('change', function() {
        //   value.html(this.value);
        //   updateData(data, geodata, resdata, meetdata, unidata, corpdata, yearSelected)
        //   updateRelations(relationdata)
        //
        // });

        updateData(data, geodata, resdata, meetdata, unidata, corpdata, yearSelected)






let timelineHeight = 0.25*windowHeight

/////timelineStart
let timelineScale = d3.scaleLinear()
  .domain([1300, 2000])
  .range([0, windowWidth]);

let timelineYScale = d3.scaleLinear()
    .domain([0, 13000000])
    .range([timelineHeight, 0])

    let timelineYScaledown = d3.scaleLinear()
        .domain([0, 10000000])
        .range([timelineHeight/2, timelineHeight])


let areaGND = d3.area()
  .x(function(d, i) {
    return timelineScale(d.year);
  })
  .y0(function(d) {
    return timelineYScale(0)
  })
  .y1(function(d) {
    return timelineYScale(d.PerPer_GND+d.CorpPer_GND+d.GeoPer_GND+d.MeetPer_GND+d.UniPer_GND)
  })
  .curve(d3.curveBasis);

  let areaKPE = d3.area()
    .x(function(d, i) {
      return timelineScale(d.year);
    })
    .y0(function(d) {
      return timelineYScale(d.PerPer_GND+d.CorpPer_GND+d.GeoPer_GND+d.MeetPer_GND+d.UniPer_GND)
    })
    .y1(function(d) {
      return timelineYScale(d.ResPer_KPE+d.PerPer_GND+d.CorpPer_GND+d.GeoPer_GND+d.MeetPer_GND+d.UniPer_GND)
    })
    .curve(d3.curveBasis);

    let areaDNB = d3.area()
      .x(function(d, i) {
        return timelineScale(d.year);
      })
      .y0(function(d) {
        return timelineYScale(d.ResPer_KPE+d.PerPer_GND+d.CorpPer_GND+d.GeoPer_GND+d.MeetPer_GND+d.UniPer_GND)
      })
      .y1(function(d) {
        return timelineYScale(d.ResPer_DNB+d.ResPer_KPE+d.PerPer_GND+d.CorpPer_GND+d.GeoPer_GND+d.MeetPer_GND+d.UniPer_GND)
      })
      .curve(d3.curveBasis);

      let areaSBB = d3.area()
        .x(function(d, i) {
          return timelineScale(d.year);
        })
        .y0(function(d) {
          return timelineYScale(d.ResPer_KPE+d.ResPer_DNB+d.PerPer_GND+d.CorpPer_GND+d.GeoPer_GND+d.MeetPer_GND+d.UniPer_GND)
        })
        .y1(function(d) {
          return timelineYScale(d.ResPer_SBB+d.ResPer_KPE+d.ResPer_DNB+d.PerPer_GND+d.CorpPer_GND+d.GeoPer_GND+d.MeetPer_GND+d.UniPer_GND)
        })
        .curve(d3.curveBasis);


        let areaZDB = d3.area()
          .x(function(d, i) {
            return timelineScale(d.year);
          })
          .y0(function(d) {
            return timelineYScale(d.ResPer_SBB+d.ResPer_KPE+d.ResPer_DNB+d.PerPer_GND+d.CorpPer_GND+d.GeoPer_GND+d.MeetPer_GND+d.UniPer_GND)
          })
          .y1(function(d) {
            return timelineYScale(d.ResPer_ZDB+d.ResPer_SBB+d.ResPer_KPE+d.ResPer_DNB+d.PerPer_GND+d.CorpPer_GND+d.GeoPer_GND+d.MeetPer_GND+d.UniPer_GND)
          })
          .curve(d3.curveBasis);

          let areaComp = d3.area()
            .x(function(d, i) {
              return timelineScale(d.year);
            })
            .y0(function(d) {
              return timelineYScale(d.ResPer_ZDB+d.ResPer_SBB+d.ResPer_KPE+d.ResPer_DNB+d.PerPer_GND+d.CorpPer_GND+d.GeoPer_GND+d.MeetPer_GND+d.UniPer_GND)
            })
            .y1(function(d) {
              return timelineYScale(d.PerPer_Comp+d.CorpPer_Comp+d.ResPer_ZDB+d.ResPer_SBB+d.ResPer_KPE+d.ResPer_DNB+d.PerPer_GND+d.CorpPer_GND+d.GeoPer_GND+d.MeetPer_GND+d.UniPer_GND)
            })
            .curve(d3.curveBasis);

  // let areaRes = d3.area()
  //   .x(function(d, i) {
  //     return timelineScale(d.year);
  //   })
  //   .y0(function(d) {
  //     return timelineYScale(0)
  //   })
  //   .y1(function(d) {
  //     return timelineYScale(0-d.PerName)
  //   })
  //   .curve(d3.curveBasis);


  // let area2 = d3.area()
  //   .y(function(d, i) {
  //     return timelineScale(d.date);
  //   })
  //   .x0(function(d) {
  //     return timelineXScale(d.countPerson)
  //   })
  //   .x1(function(d) {
  //     return timelineXScale(d.countPerson+d.countEdge)
  //   })
  //   .curve(d3.curveBasis);
  //
  //   let area3 = d3.area()
  //     .y(function(d, i) {
  //       return timelineScale(d.date);
  //     })
  //     .x0(function(d) {
  //       return timelineXScale(d.countPerson+d.countEdge)
  //     })
  //     .x1(function(d) {
  //       return timelineXScale(d.countPerson+d.countEdge+d.countResource)
  //     })
  //     .curve(d3.curveBasis);



let areachartGroup = timelineVis.append("g").attr("class", "areachartGroup")//.attr("transform", "translate(" + 116 + "," + timelineMarginTop + ")")

let areachart = d3.selectAll(".areachartGroup")

let areachartRectangles = areachart.append("g").attr("class", "axisRectangles")



let rectI = 1300
while(rectI<=2000){

  areachartRectangles.append("rect")
  .attr("height", timelineHeight)
  .attr("width", timelineScale(1350)-timelineScale(1300)) //breite für 50 Jahre
  .attr("x", timelineScale(rectI))
  .attr("y",0)
  .classed("timelineRect", true)
  .classed("timelineRectSelected", function(){if(rectI == yearSelected){return true}else{return false}})
  .attr("data-year", rectI)
  .on("mouseover", function(d){
    d3.select(this)//.attr("fill", "#d9d9d9")
    .classed("timelineRecthover", true)
  })
  .on("mouseout", function(d){
    d3.select(this)//.attr("fill", "#fafafa")
    .classed("timelineRecthover", false)
  })
  .on("click", function(d){
  d3.selectAll(".timelineRect").classed("timelineRectSelected", false)
  d3.select(this).classed("timelineRectSelected", true)
  yearSelected = d3.select(this).attr("data-year")
  updateData(data, geodata, resdata, meetdata, unidata, corpdata, yearSelected)
  updateRelations(relationdata)
  })


  areachartRectangles.append("text")
  .text(rectI)
  .attr("y", 12)
  .attr("x", timelineScale(rectI))
  .style("font-size", 10)
  .style("font-weight", 500)
  .style("fill", "black")
  .style("stroke", "#fafafa")
  .style("stroke-width", 4)
  .style("stroke-linecap", "round")
  .style("text-anchor", "middle")

  areachartRectangles.append("text")
  .text(rectI)
  .attr("y", 12)
  .attr("x", timelineScale(rectI))
  .style("font-size", 10)
  .style("font-weight", 500)
  .style("fill", "black")
  .style("text-anchor", "middle")

  rectI = rectI+50
}

areachartRectangles.append("rect")
.attr("x",0)
.attr("y",0)
.attr("height", 1)
.style("fill", "black")
.attr("width", "100%")






areachart.append("g").attr("class", "axisTime")//.call(d3.axisBottom(timelineScale).ticks(14).tickFormat(d3.format("d")).tickSize(timelineHeight)).attr("transform", "translate(" + 0 + "," + (0) + ")")
d3.selectAll(".tick").selectAll("text")
.attr("transform", "translate(" + [0, -timelineHeight] + ")");

areachart.append("path")
  .datum(timelinerelations)
  .attr("d", areaGND)
  .style("fill", colorScaleEdges("GND"))
  .style("opacity", 1)
  .style("stroke", "white")
  .style("stroke-width", 1)

  areachart.append("path")
    .datum(timelinerelations)
    .attr("d", areaKPE)
    .style("fill", colorScaleEdges("KPE"))
    .style("opacity", 1)
    .style("stroke", "white")
    .style("stroke-width", 1)

    areachart.append("path")
      .datum(timelinerelations)
      .attr("d", areaDNB)
      .style("fill", colorScaleEdges("DNB"))
      .style("opacity", 1)
      .style("stroke", "white")
      .style("stroke-width", 1)

      //
       areachart.append("path")
        .datum(timelinerelations)
        .attr("d", areaSBB)
        .style("fill", colorScaleEdges("SBB"))
        .style("opacity", 1)
        .style("stroke", "white")
        .style("stroke-width", 1)

        areachart.append("path")
         .datum(timelinerelations)
         .attr("d", areaZDB)
         .style("fill", colorScaleEdges("ZDB"))
         .style("opacity", 1)
         .style("stroke", "white")
         .style("stroke-width", 1)

         areachart.append("path")
          .datum(timelinerelations)
          .attr("d", areaComp)
          .style("fill", colorScaleEdges("Comp"))//"url(#diagonalHatch)")
          .style("opacity", 1)
          .style("stroke", "white")
          .style("stroke-width", 1)
//timelineEnd




///relations edges Start
let relationsYearSelected = yearSelected


///all edges except PerName -- PerName
// relationdata.filter(function(d){return d.year == relationsYearSelected && d.target != "PerName"}).forEach((d, i) => {


let DNBResLineStrength = edgesSizeScale(relationdata.filter(function(d){return d.year == relationsYearSelected && d.target == "Resource" && d.type == "DNB"})[0].value)/2
let KPEResLineStrength = edgesSizeScale(relationdata.filter(function(d){return d.year == relationsYearSelected && d.target == "Resource" && d.type == "KPE"})[0].value)/2
let SBBResLineStrength = edgesSizeScale(relationdata.filter(function(d){return d.year == relationsYearSelected && d.target == "Resource" && d.type == "SBB"})[0].value)/2
let ZDBResLineStrength = edgesSizeScale(relationdata.filter(function(d){return d.year == relationsYearSelected && d.target == "Resource" && d.type == "ZDB"})[0].value)/2
let lineGap = 2

let resPerRels = d3.select("#relationsvis").append("g").attr("class", "resPerRels").attr("transform", "translate(0,"+(-((lineGap*3)+DNBResLineStrength+KPEResLineStrength+SBBResLineStrength+ZDBResLineStrength)/2)+")")

resPerRels.selectAll(".relationLine")
  .data(relationdata.filter(function(d){return d.year == relationsYearSelected && d.target == "Resource"}))
  .join("line")
  .classed("relationLine", true)
  .attr("x1", d => PerNameCenter[0])
  .attr("y1", d => PerNameCenter[1])
  .attr("x2", function(d){return ResourcesCenter[0]})
  .attr("y2", function(d){return ResourcesCenter[1]})
  .attr("stroke", function(d){return colorScaleEdges(d.type)})
  .attr("stroke-width",function(d){return edgesSizeScale(d.value)})
  .attr("transform", function(d){

      if(d.type == "DNB"){return "translate(0,"+(0)+")"}
          else if(d.type == "KPE"){return "translate(0,"+(lineGap+DNBResLineStrength+KPEResLineStrength)+")"}
          else if(d.type == "SBB"){return "translate(0,"+(2*lineGap+DNBResLineStrength+KPEResLineStrength*2+SBBResLineStrength)+")"}
          else if(d.type == "ZDB"){return "translate(0,"+(3*lineGap+DNBResLineStrength+KPEResLineStrength*2+SBBResLineStrength*2+ZDBResLineStrength)+")"}
  })


  let corpPerRels = d3.select("#relationsvis").append("g").attr("class", "corpPerRels")//.attr("transform", "translate(0,"+(-((lineGap*3)+DNBResLineStrength+KPEResLineStrength+SBBResLineStrength+ZDBResLineStrength)/2)+")")
  let CompCorpLineStrength = edgesSizeScale(relationdata.filter(function(d){return d.year == relationsYearSelected && d.target == "CorpName" && d.type == "Comp"})[0].value)/2
  let GNDCorpLineStrength = edgesSizeScale(relationdata.filter(function(d){return d.year == relationsYearSelected && d.target == "CorpName" && d.type == "GND"})[0].value)/2

  corpPerRels.selectAll(".relationLine")
    .data(relationdata.filter(function(d){return d.year == relationsYearSelected && d.target == "CorpName"}))
    .join("line")
    .classed("relationLine", true)
    .attr("x1", d => PerNameCenter[0])
    .attr("y1", d => PerNameCenter[1])
    .attr("x2", function(d){return CorpNameCenter[0]})
    .attr("y2", function(d){return CorpNameCenter[1]})
    .attr("stroke", function(d){return colorScaleEdges(d.type)})
    .attr("stroke-width",function(d){return edgesSizeScale(d.value)})
    .attr("transform", function(d){

        if(d.type == "Comp"){return "translate(0,"+(CompCorpLineStrength)+")"}
            else if(d.type == "GND"){return "translate(0,"+(2*lineGap+2*CompCorpLineStrength+GNDCorpLineStrength)+")"}
    })



let otherRels = d3.select("#relationsvis").append("g").attr("class", "otherRels")

otherRels.selectAll(".relationLine")
  .data(relationdata.filter(function(d){return d.year == relationsYearSelected && d.target != "PerName" && d.target !="Resource" && d.target !="CorpName"}))
  .join("line")
  .classed("relationLine", true)
  .attr("x1", d => PerNameCenter[0])
  .attr("y1", d => PerNameCenter[1])
  .attr("x2", function(d){
    if(d.target == "GeoName"){return GeoNameCenter[0]}
    else if(d.target == "MeetName"){return MeetNameCenter[0]}
      else if(d.target == "UniTitle"){return UniTitleCenter[0]}
  })
  .attr("y2", function(d){
    if(d.target == "GeoName"){return GeoNameCenter[1]}
    else if(d.target == "MeetName"){return MeetNameCenter[1]}
      else if(d.target == "UniTitle"){return UniTitleCenter[1]}
  })
  .attr("stroke", function(d){return colorScaleEdges(d.type)})
  .attr("stroke-width",function(d){return edgesSizeScale(d.value)})
  .attr("transform", function(d){return "translate(0,"+(edgesSizeScale(d.value))+")"})
    // .style("stroke-dasharray", function() {
    //           if (d.type == "Comp_SBB" || d.type == "Comp_KPE" || d.type == "Comp_DNB") {
    //             return "40 5"
    //           } else {
    //             return null
    //           }
    //         })

//});



//PerName -- PerName Arcs

let resPerPer= d3.select("#relationsvis").append("g").attr("class", "resPerPer")//.attr("transform", "translate(0,"+(-((lineGap*3)+DNBResLineStrength+KPEResLineStrength+SBBResLineStrength+ZDBResLineStrength)/2)+")")

resPerPer.selectAll(".relationLine")
  .data(relationdata.filter(function(d){return d.year == relationsYearSelected && d.target == "PerName"}))
  .join("path")
  .classed("relationLine", true)
  .attr("d", function(d){
    let y1 = PerNameCenter[1]
    let x1 = PerNameCenter[0]-30
    let CompLineStrength = edgesSizeScale(relationdata.filter(function(d){return d.year == relationsYearSelected && d.target == "PerName" && d.type == "Comp"})[0].value)/2

    if(d.type == "Comp"){
      return `M${x1},${y1} v ${Radius-20} c 0 60 60 60 60 0 v -${Radius-20}`
    }else if(d.type =="GND"){
    //  return `M${x1-CompLineStrength-4},${y1} v ${Radius-20+CompLineStrength+2} c 0 ${60+2*CompLineStrength+4} ${60+2*CompLineStrength+8} ${60+2*CompLineStrength+4}  ${60+2*CompLineStrength+8} 0 v -${Radius-20+CompLineStrength+2}`
      return `M${x1-CompLineStrength-4},${y1} v ${Radius-20} c 0 ${60+2*CompLineStrength+4} ${60+2*CompLineStrength+8} ${60+2*CompLineStrength+4}  ${60+2*CompLineStrength+8} 0 v -${Radius-20}`
    }
  })
  .attr("stroke-width", function(d){return edgesSizeScale(d.value)})
  .attr("stroke", function(d){return colorScaleEdges(d.type)})
  .style("fill", "none")


///relations edges End

function updateRelations(relationdata){
relationsYearSelected = yearSelected

  DNBResLineStrength = edgesSizeScale(relationdata.filter(function(d){return d.year == relationsYearSelected && d.target == "Resource" && d.type == "DNB"})[0].value)/2
  KPEResLineStrength = edgesSizeScale(relationdata.filter(function(d){return d.year == relationsYearSelected && d.target == "Resource" && d.type == "KPE"})[0].value)/2
  SBBResLineStrength = edgesSizeScale(relationdata.filter(function(d){return d.year == relationsYearSelected && d.target == "Resource" && d.type == "SBB"})[0].value)/2
  ZDBResLineStrength = edgesSizeScale(relationdata.filter(function(d){return d.year == relationsYearSelected && d.target == "Resource" && d.type == "ZDB"})[0].value)/2
  lineGap = 2
  resPerRels = d3.select(".resPerRels").attr("transform", "translate(0,"+(-((lineGap*3)+DNBResLineStrength+KPEResLineStrength+SBBResLineStrength+ZDBResLineStrength)/2)+")")

  resPerRels.selectAll(".relationLine")
    .data(relationdata.filter(function(d){return d.year == relationsYearSelected && d.target == "Resource"}))
    .transition()
    .attr("x1", d => PerNameCenter[0])
    .attr("y1", d => PerNameCenter[1])
    .attr("x2", function(d){return ResourcesCenter[0]})
    .attr("y2", function(d){return ResourcesCenter[1]})
    .attr("stroke", function(d){return colorScaleEdges(d.type)})
    .attr("stroke-width",function(d){return edgesSizeScale(d.value)})
    .attr("transform", function(d){

        if(d.type == "DNB"){return "translate(0,"+(0)+")"}
            else if(d.type == "KPE"){return "translate(0,"+(lineGap+DNBResLineStrength+KPEResLineStrength)+")"}
            else if(d.type == "SBB"){return "translate(0,"+(2*lineGap+DNBResLineStrength+KPEResLineStrength*2+SBBResLineStrength)+")"}
            else if(d.type == "ZDB"){return "translate(0,"+(3*lineGap+DNBResLineStrength+KPEResLineStrength*2+SBBResLineStrength*2+ZDBResLineStrength)+")"}
    })


    resPerPer.selectAll(".relationLine")
      .data(relationdata.filter(function(d){return d.year == relationsYearSelected && d.target == "PerName"}))
      .transition()
      .attr("d", function(d){
        let y1 = PerNameCenter[1]
        let x1 = PerNameCenter[0]-30
        let CompLineStrength = edgesSizeScale(relationdata.filter(function(d){return d.year == relationsYearSelected && d.target == "PerName" && d.type == "Comp"})[0].value)/2

        if(d.type == "Comp"){
          return `M${x1},${y1} v ${Radius-20} c 0 60 60 60 60 0 v -${Radius-20}`
        }else if(d.type =="GND"){
        //  return `M${x1-CompLineStrength-4},${y1} v ${Radius-20+CompLineStrength+2} c 0 ${60+2*CompLineStrength+4} ${60+2*CompLineStrength+8} ${60+2*CompLineStrength+4}  ${60+2*CompLineStrength+8} 0 v -${Radius-20+CompLineStrength+2}`
          return `M${x1-CompLineStrength-4},${y1} v ${Radius-20} c 0 ${60+2*CompLineStrength+4} ${60+2*CompLineStrength+8} ${60+2*CompLineStrength+4}  ${60+2*CompLineStrength+8} 0 v -${Radius-20}`
        }
      })
      .attr("stroke-width", function(d){return edgesSizeScale(d.value)})
      .attr("stroke", function(d){return colorScaleEdges(d.type)})
      .style("fill", "none")


      CompCorpLineStrength = edgesSizeScale(relationdata.filter(function(d){return d.year == relationsYearSelected && d.target == "CorpName" && d.type == "Comp"})[0].value)/2
      GNDCorpLineStrength = edgesSizeScale(relationdata.filter(function(d){return d.year == relationsYearSelected && d.target == "CorpName" && d.type == "GND"})[0].value)/2

      corpPerRels.selectAll(".relationLine")
        .data(relationdata.filter(function(d){return d.year == relationsYearSelected && d.target == "CorpName"}))
        .transition()
        .attr("x1", d => PerNameCenter[0])
        .attr("y1", d => PerNameCenter[1])
        .attr("x2", function(d){return CorpNameCenter[0]})
        .attr("y2", function(d){return CorpNameCenter[1]})
        .attr("stroke", function(d){return colorScaleEdges(d.type)})
        .attr("stroke-width",function(d){return edgesSizeScale(d.value)})
        .attr("transform", function(d){

            if(d.type == "Comp"){return "translate(0,"+(CompCorpLineStrength)+")"}
                else if(d.type == "GND"){return "translate(0,"+(2*lineGap+2*CompCorpLineStrength+GNDCorpLineStrength)+")"}
        })


        otherRels.selectAll(".relationLine")
          .data(relationdata.filter(function(d){return d.year == relationsYearSelected && d.target != "PerName" && d.target !="Resource" && d.target !="CorpName"}))
          .transition()
          .attr("x1", d => PerNameCenter[0])
          .attr("y1", d => PerNameCenter[1])
          .attr("x2", function(d){
            if(d.target == "GeoName"){return GeoNameCenter[0]}
            else if(d.target == "MeetName"){return MeetNameCenter[0]}
              else if(d.target == "UniTitle"){return UniTitleCenter[0]}
          })
          .attr("y2", function(d){
            if(d.target == "GeoName"){return GeoNameCenter[1]}
            else if(d.target == "MeetName"){return MeetNameCenter[1]}
              else if(d.target == "UniTitle"){return UniTitleCenter[1]}
          })
          .attr("stroke", function(d){return colorScaleEdges(d.type)})
          .attr("stroke-width",function(d){return edgesSizeScale(d.value)})
          .attr("transform", function(d){return "translate(0,"+(edgesSizeScale(d.value))+")"})

}



        function updateData(data, geodata, resdata, meetdata, unidata, corpdata, yearSelected) {

          Radius
          CirclingPolygon
          Polygons
          RadiusGeo
          CirclingPolygonGeo
          PolygonsGeo
          RadiusRes
          CirclingPolygonRes
          PolygonsRes
          RadiusMeet
          CirclingPolygonMeet
          PolygonsMeet
          RadiusUni
          CirclingPolygonUni
          PolygonsUni
          RadiusCorp
          CirclingPolygonCorp
          PolygonsCorp

          top100Value = 0
          otherValue = 0
          totalValue = 0
          top100ValueGeo = 0
          otherValueGeo = 0
          totalValueGeo = 0
          top100ValueRes = 0
          otherValueRes = 0
          totalValueRes = 0
          top100ValueMeet = 0
          otherValueMeet = 0
          totalValueMeet = 0
          top100ValueUni = 0
          otherValueUni = 0
          totalValueUni = 0
          top100ValueCorp = 0
          otherValueCorp = 0
          totalValueCorp = 0


          selectionData = data.filter(function(d) {
            return d.year == yearSelected && d.value != ""
          })

          selectionDataGeo = geodata.filter(function(d) {
            return d.year == yearSelected && d.value != ""
          })

          selectionDataRes = resdata.filter(function(d) {
            return d.year == yearSelected && d.value != ""
          })

          selectionDataMeet = meetdata.filter(function(d) {
            return d.year == yearSelected && d.value != ""
          })

          selectionDataUni = unidata.filter(function(d) {
            return d.year == yearSelected && d.value != ""
          })

          selectionDataCorp = corpdata.filter(function(d) {
            return d.year == yearSelected && d.value != ""
          })

          console.log(selectionDataCorp)

          selectionDataState = selectionData.sort((a, b) => d3.descending(a.value, b.value)).slice(0)
          selectionDataStateGeo = selectionDataGeo.sort((a, b) => d3.descending(a.value, b.value)).slice(0)
          selectionDataStateRes = selectionDataRes.sort((a, b) => d3.descending(a.value, b.value)).slice(0)
          selectionDataStateMeet = selectionDataMeet.sort((a, b) => d3.descending(a.value, b.value)).slice(0)
          selectionDataStateUni = selectionDataUni.sort((a, b) => d3.descending(a.value, b.value)).slice(0)
          selectionDataStateCorp = selectionDataCorp.sort((a, b) => d3.descending(a.value, b.value)).slice(0)

      //    console.log(selectionData)

          selectionDataState.forEach(function(d, i) {
            totalValue += d.value
            if (i < 100) {
              top100Value += d.value
              d.show = true
            } else {
              otherValue += d.value
              d.show = false
            }
          })


          selectionDataState.push({
            entityName: "Sonstige",
            value: otherValue,
            show: true,
            year: yearSelected

          })

          selectionDataStateGeo.forEach(function(d, i) {
            totalValueGeo += d.value
            if (i < 100) {
              top100ValueGeo += d.value
              d.show = true
            } else {
              otherValueGeo += d.value
              d.show = false
            }
          })


          selectionDataStateGeo.push({
            entityName: "Sonstige",
            value: otherValueGeo,
            show: true,
            year: yearSelected

          })


          selectionDataStateRes.forEach(function(d, i) {
            totalValueRes += d.value
            if (i < 100) {
              top100ValueRes += d.value
              d.show = true
            } else {
              otherValueRes += d.value
              d.show = false
            }
          })


          selectionDataStateRes.push({
            entityName: "Sonstige",
            value: otherValueRes,
            show: true,
            year: yearSelected

          })

          selectionDataStateMeet.forEach(function(d, i) {
            totalValueMeet += d.value
            if (i < 100) {
              top100ValueMeet += d.value
              d.show = true
            } else {
              otherValueMeet += d.value
              d.show = false
            }
          })


          selectionDataStateMeet.push({
            entityName: "Sonstige",
            value: otherValueMeet,
            show: true,
            year: yearSelected

          })


          selectionDataStateUni.forEach(function(d, i) {
            totalValueUni += d.value
            if (i < 100) {
              top100ValueUni += d.value
              d.show = true
            } else {
              otherValueUni += d.value
              d.show = false
            }
          })


          selectionDataStateUni.push({
            entityName: "Sonstige",
            value: otherValueUni,
            show: true,
            year: yearSelected

          })

          selectionDataStateCorp.forEach(function(d, i) {
            totalValueCorp += d.value
            if (i < 100) {
              top100ValueCorp += d.value
              d.show = true
            } else {
              otherValueCorp += d.value
              d.show = false
            }
          })


          selectionDataStateCorp.push({
            entityName: "Sonstige",
            value: otherValueCorp,
            show: true,
            year: yearSelected

          })

          initData(data, geodata, resdata, meetdata, unidata, corpdata);
        //  initData(geodata);


          //simulation1 start
          Simulation = d3.voronoiMapSimulation(selectionDataState.filter(function(d, i) {
              return d.show == true
            }))
            .clip(CirclingPolygon)
            .weight(function(d) {
              return d.value
            })
            .initialPosition(d3.voronoiMapInitialPositionPie().startAngle(-Math.PI * 3 / 5))
            .on("tick", function() {
              Polygons = Simulation.state().polygons;
              if (Simulation.state().ended == true) {
                updateTreemap(svg1id, PerNameCenter, Polygons, totalValue, Radius, "Personen (")
              }
            })

  if(totalValueGeo > 0){

            SimulationGeo = d3.voronoiMapSimulation(selectionDataStateGeo.filter(function(d, i) {
                return d.show == true
              }))
              .clip(CirclingPolygonGeo)
              .weight(function(d) {
                return d.value
              })
              .initialPosition(d3.voronoiMapInitialPositionPie().startAngle(-Math.PI * 3 / 5))
              .on("tick", function() {
                PolygonsGeo = SimulationGeo.state().polygons;
                if (SimulationGeo.state().ended == true) {
                  updateTreemap(svg2id, GeoNameCenter, PolygonsGeo, totalValueGeo, RadiusGeo, "Geographika (")
                }
              })
  }

if(totalValueRes > 0){

              SimulationRes = d3.voronoiMapSimulation(selectionDataStateRes.filter(function(d, i) {
                  return d.show == true
                }))
                .clip(CirclingPolygonRes)
                .weight(function(d) {
                  return d.value
                })
                .initialPosition(d3.voronoiMapInitialPositionPie().startAngle(-Math.PI * 3 / 5))
                .on("tick", function() {
                  PolygonsRes = SimulationRes.state().polygons;
                  if (SimulationRes.state().ended == true) {
                    updateTreemap(svg3id, ResourcesCenter, PolygonsRes, totalValueRes, RadiusRes, "Ressourcen (")
                  }
                })
}

if(totalValueMeet > 0){

  SimulationMeet = d3.voronoiMapSimulation(selectionDataStateMeet.filter(function(d, i) {
      return d.show == true
    }))
    .clip(CirclingPolygonMeet)
    .weight(function(d) {
      return d.value
    })
    .initialPosition(d3.voronoiMapInitialPositionPie().startAngle(-Math.PI * 3 / 5))
    .on("tick", function() {
      PolygonsMeet = SimulationMeet.state().polygons;
      if (SimulationMeet.state().ended == true) {
        updateTreemap(svg4id, MeetNameCenter, PolygonsMeet, totalValueMeet, RadiusMeet, "Veranstaltungen (")
      }
    })

}


if(totalValueUni > 0){
                  SimulationUni = d3.voronoiMapSimulation(selectionDataStateUni.filter(function(d, i) {
                      return d.show == true
                    }))
                    .clip(CirclingPolygonUni)
                    .weight(function(d) {
                      return d.value
                    })
                    .initialPosition(d3.voronoiMapInitialPositionPie().startAngle(-Math.PI * 3 / 5))
                    .on("tick", function() {
                      PolygonsUni = SimulationUni.state().polygons;
                      if (SimulationUni.state().ended == true) {
                        updateTreemap(svg5id, UniTitleCenter, PolygonsUni, totalValueUni, RadiusUni, "Werke (")
                      }
                    })
}



if(totalValueCorp > 0){
                  SimulationCorp = d3.voronoiMapSimulation(selectionDataStateCorp.filter(function(d, i) {
                      return d.show == true
                    }))
                    .clip(CirclingPolygonCorp)
                    .weight(function(d) {
                      return d.value
                    })
                    .initialPosition(d3.voronoiMapInitialPositionPie().startAngle(-Math.PI * 3 / 5))
                    .on("tick", function() {
                      PolygonsCorp = SimulationCorp.state().polygons;
                      if (SimulationCorp.state().ended == true) {
                        updateTreemap(svg6id, CorpNameCenter, PolygonsCorp, totalValueCorp, RadiusCorp, "Körperschaften (")
                      }
                    })
}

            //simulation1 end




        }



        initLayout(svg1id, PerNameCenter, totalValue, Radius, "Personen (", "PerName");
        initLayout(svg2id, GeoNameCenter, totalValueGeo, RadiusGeo, "Geographika (", "GeoName")
        initLayout(svg3id, ResourcesCenter, totalValueRes, RadiusRes, "Ressourcen (", "Resources")
        initLayout(svg4id, MeetNameCenter, totalValueMeet, RadiusMeet, "Veranstaltungen (", "MeetName")
        initLayout(svg5id, UniTitleCenter, totalValueUni, RadiusUni, "Werke (", "UniTitle")
        initLayout(svg6id, CorpNameCenter, totalValueCorp, RadiusCorp, "Körperschaften (", "CorpName")




  //simulation1 start
        Simulation = d3.voronoiMapSimulation(selectionDataState.filter(function(d, i) {
            return d.show == true
          }))
          .clip(CirclingPolygon)
          .weight(function(d) {
            return d.value
          })
          .initialPosition(d3.voronoiMapInitialPositionPie().startAngle(-Math.PI * 3 / 5))
          .on("tick", function() {
            Polygons = Simulation.state().polygons;
            if (Simulation.state().ended == true) {
              drawTreemap(svg1id, Polygons)
            }
          })

          SimulationGeo = d3.voronoiMapSimulation(selectionDataStateGeo.filter(function(d, i) {
              return d.show == true
            }))
            .clip(CirclingPolygonGeo)
            .weight(function(d) {
              return d.value
            })
            .initialPosition(d3.voronoiMapInitialPositionPie().startAngle(-Math.PI * 3 / 5))
            .on("tick", function() {
              PolygonsGeo = SimulationGeo.state().polygons;
              if (SimulationGeo.state().ended == true) {
                drawTreemap(svg2id, PolygonsGeo)
              }
            })

            SimulationRes = d3.voronoiMapSimulation(selectionDataStateRes.filter(function(d, i) {
                return d.show == true
              }))
              .clip(CirclingPolygonRes)
              .weight(function(d) {
                return d.value
              })
              .initialPosition(d3.voronoiMapInitialPositionPie().startAngle(-Math.PI * 3 / 5))
              .on("tick", function() {
                PolygonsRes = SimulationRes.state().polygons;
                if (SimulationRes.state().ended == true) {
                  drawTreemap(svg3id, PolygonsRes)
                }
              })

              SimulationMeet = d3.voronoiMapSimulation(selectionDataStateMeet.filter(function(d, i) {
                  return d.show == true
                }))
                .clip(CirclingPolygonMeet)
                .weight(function(d) {
                  return d.value
                })
                .initialPosition(d3.voronoiMapInitialPositionPie().startAngle(-Math.PI * 3 / 5))
                .on("tick", function() {
                  PolygonsMeet = SimulationMeet.state().polygons;
                  if (SimulationMeet.state().ended == true) {
                    drawTreemap(svg4id, PolygonsMeet)
                  }
                })


                SimulationUni = d3.voronoiMapSimulation(selectionDataStateUni.filter(function(d, i) {
                    return d.show == true
                  }))
                  .clip(CirclingPolygonUni)
                  .weight(function(d) {
                    return d.value
                  })
                  .initialPosition(d3.voronoiMapInitialPositionPie().startAngle(-Math.PI * 3 / 5))
                  .on("tick", function() {
                    PolygonsUni = SimulationUni.state().polygons;
                    if (SimulationUni.state().ended == true) {
                      drawTreemap(svg5id, PolygonsUni)
                    }
                  })


                  SimulationCorp = d3.voronoiMapSimulation(selectionDataStateCorp.filter(function(d, i) {
                      return d.show == true
                    }))
                    .clip(CirclingPolygonCorp)
                    .weight(function(d) {
                      return d.value
                    })
                    .initialPosition(d3.voronoiMapInitialPositionPie().startAngle(-Math.PI * 3 / 5))
                    .on("tick", function() {
                      PolygonsCorp = SimulationCorp.state().polygons;
                      if (SimulationCorp.state().ended == true) {
                        drawTreemap(svg6id, PolygonsCorp)
                      }
                    })
  //simulation1 end



      });




      function initData(data, geodata, resdata, meetdata, unidata, corpdata) {
        Radius = radiusScale(totalValue)
        CirclingPolygon = computeCirclingPolygon(Radius);

        RadiusGeo = radiusScale(totalValueGeo)
        CirclingPolygonGeo = computeCirclingPolygon(RadiusGeo);

        RadiusRes = radiusScale(totalValueRes)
        CirclingPolygonRes = computeCirclingPolygon(RadiusRes);

        RadiusMeet = radiusScale(totalValueMeet)
        CirclingPolygonMeet = computeCirclingPolygon(RadiusMeet);

        RadiusUni = radiusScale(totalValueUni)
        CirclingPolygonUni = computeCirclingPolygon(RadiusUni);

        RadiusCorp = radiusScale(totalValueCorp)
        CirclingPolygonCorp = computeCirclingPolygon(RadiusCorp);


      }

      function computeCirclingPolygon(radius) {
        var points = 60,
          increment = _2PI / points,
          circlingPolygon = [];

        for (var a = 0, i = 0; i < points; i++, a += increment) {
          circlingPolygon.push(
            [radius * Math.cos(a), radius * Math.sin(a)]
          )
        }

        return circlingPolygon;
      };

      function initLayout(svgid, TreemapCenter, totalValue, Radius, title, type) {

      let svgG = d3.select(svgid)

      let drawingArea = svgG.append("g")
          .classed("drawingArea", true)
          .attr("transform", "translate(" + [margin.left, margin.top] + ")");

      let categoryContainer = drawingArea.append("g")
          .classed("container", true)
          .attr("transform", "translate(" + TreemapCenter + ")");

          categoryContainer.append("text")
            .classed("labelbg", true)
            .attr("transform", "translate(0," + (-Radius - 6) + ")")
            .text(title + Number(totalValue).toLocaleString()  + ")")
            .append("tspan")
            .text(" ▼")
            .style("font-size", 7);


        categoryContainer.append("text")
          .classed("label", true)
          .style("cursor", "pointer")
          .on("click", function(){
            createTopList(type)
          })
          .attr("transform", "translate(0," + (-Radius - 6) + ")")
          .text(title + Number(totalValue).toLocaleString()  + ")")
          .append("tspan")
          .text(" ▼")
          .style("font-size", 7)

        //    .text(title + Number(totalValue).toLocaleString()  + ")");


        categoryContainer.append("g")
          .classed('whitetreebg', true)
          .append("circle")
          .attr("cx", 0)
          .attr("cy", 0)
          .attr("r", Radius+3)
          .attr("fill", "#fafafa");

        categoryContainer.append("g")
          .classed('cells', true);



      }



      function updateTreemap(svgid, TreemapCenter, polygons, totalValue, Radius, title) {
        let container
      //  let polygons


        //container = categoryContainer;
      //  polygons = Polygons;
      //  costAccessor = valueAccessor;



        d3.select(svgid).select(".drawingArea")
          .transition()
          .attr("transform", "translate(" + [margin.left, margin.top] + ")");

        d3.select(svgid).select(".container")
          .transition()
          .attr("transform", "translate(" + TreemapCenter + ")");

          d3.select(svgid).select(".labelbg")
            .transition()
            .attr("transform", "translate(0," + (-Radius - 6) + ")")


            d3.select(svgid).select(".labelbg")
            .text(title + Number(totalValue).toLocaleString()  + ")")
            .append("tspan")
            .text(" ▼")
            .style("font-size", 7);


        d3.select(svgid).select(".label")
          .transition()
          .attr("transform", "translate(0," + (-Radius - 6) + ")")


          d3.select(svgid).select(".label")
          .text(title + Number(totalValue).toLocaleString()  + ")")
          .append("tspan")
          .text(" ▼")
          .style("font-size", 7);

        d3.select(svgid).select(".whitetreebg").select("circle")
            .transition()
            .attr("r", Radius+3)


        var cells = d3.select(svgid).select(".cells")
          .selectAll(".cell")
          .data(polygons);

        cells.join("path")
          .classed("cell", true)
          .merge(cells)
          //.transition()
          //.attr("filter", "url(#inset-shadow)")
          .transition()
          .attr("d", function(d) {
            return "M" + d.join(",") + "z";
          })
          .style("fill", function(d) {
            if (d.site.originalObject.data.originalData.entityName == "Sonstige") {
              return "white"
            }else{
              return colorScale(d.site.originalObject.data.originalData.entityName)
            }
            //		return d.site.originalObject.data.originalData.color;
          })

        d3.select(svgid).selectAll(".cell").on("mouseover", function(d, i) {
            div.select("p")
              .text(d.site.originalObject.data.originalData.entityName + ": " + d.site.originalObject.data.originalData.value)
              .style("font-weight", "bold")

            div.style("opacity", .9)

          })
          .on("mousemove", function(d, i) {

            div
              .style("left", (d3.event.pageX + 5) + "px")
              .style("top", (d3.event.pageY - 5) + "px");
          })
          .on("mouseout", function(d) {
            d3.selectAll(".link").style("opacity", 0.2)

            div.style("opacity", 0);
          });



      }





      function drawTreemap(svgid, polygons) {
        let container
      //  let polygons

        // container = categoryContainer;
    //    polygons = Polygons;

        var cells = d3.select(svgid).select(".cells")
          .selectAll(".cell")
          .data(polygons);

        cells.enter()
          .append("path")
          .classed("cell", true)
          .merge(cells)
          //  .attr("filter", "url(#inset-shadow)")
          .attr("d", function(d) {
            return "M" + d.join(",") + "z";
          })
          .style("fill", function(d) {
            if (d.site.originalObject.data.originalData.entityName == "Sonstige") {
              return "white"
            }else{
              return colorScale(d.site.originalObject.data.originalData.entityName)
            }
            //		return d.site.originalObject.data.originalData.color;
          })
          .on("mouseover", function(d, i) {
            div.select("p")
              .text(d.site.originalObject.data.originalData.entityName + ": " + d.site.originalObject.data.originalData.value)
              .style("font-weight", "bold")

            div.style("opacity", .9)

          })
          .on("mousemove", function(d, i) {

            div
              .style("left", (d3.event.pageX + 5) + "px")
              .style("top", (d3.event.pageY - 5) + "px");
          })
          .on("mouseout", function(d) {
            d3.selectAll(".link").style("opacity", 0.2)

            div.style("opacity", 0);
          });



      }


      function createTopList(type){
        d3.selectAll(".toplistDiv").remove()
        d3.select("body").append("div").classed("toplistDiv", true)
        d3.select(".toplistDiv").append("input").classed("toplistsearch", true).attr("type", "text").attr("placeholder", "Liste durchsuchen")
        .on("input", function(){
          let inputThis = this.value.toLowerCase()

            d3.selectAll(".toplistentries").style("display", function(d){
              if(d.entityName.toLowerCase().includes(inputThis)){
                return "block"
              }else{return "none"}
            })

        })

        d3.select(".toplistDiv").append("p").attr("class", "toplistCross").text("✕").on("click", function(){d3.selectAll(".toplistDiv").remove()})

        d3.select(".toplistDiv").append("div").classed("toplisttext", true)

        d3.select(".toplisttext").selectAll(".toplistentries")
        .data(function(){
          if(type == "PerName"){
            return selectionData
          }else if(type == "GeoName"){
            return selectionDataGeo
          }else if(type == "Resources"){
            return selectionDataRes
          }else if(type == "MeetName"){
            return selectionDataMeet
          }else if(type == "UniTitle"){
            return selectionDataStateUni
          }else if(type == "CorpName"){
            return selectionDataCorp
          }


        })
        .join("p")
        .classed("toplistentries", true)
        .text(function(d){return d.entityName + " (" + d.value + ")"})

        }
// }
//
// voronoiAll()


  </script>
</body>

</html>
